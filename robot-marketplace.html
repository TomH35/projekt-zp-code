<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Robot Marketplace</title>
  <script src="js/auth-check.js"></script>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <script src="js-libraries/bootstrap.bundle.min.js"></script>
  <script src="js/token-validator.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 30px;
    }
    .search-container {
      margin-bottom: 20px;
    }
    .scrollable-table {
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Robot Marketplace</h1>
    
    <div class="search-container">
      <div class="row">
        <div class="col-md-8 mx-auto">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by script name or username">
        </div>
      </div>
    </div>
    
    <div class="scrollable-table">
      <table class="table table-striped" id="marketplaceTable">
        <thead>
          <tr>
            <th>Script Name</th>
            <th>Author</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    
    <div class="text-center mt-3">
      <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">Back</button>
    </div>
  </div>

  <div class="modal fade" id="viewScriptModal" tabindex="-1" aria-labelledby="viewScriptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewScriptModalLabel">View Script</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <pre id="scriptContent" style="white-space: pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allScripts = [];

    document.addEventListener("DOMContentLoaded", function() {
      const jwt = localStorage.getItem("jwt");
      if (!jwt) {
        window.location.href = "sign-in.html";
        return;
      }
      fetchPublicScripts();

      document.getElementById("searchInput").addEventListener("input", function() {
        filterScripts(this.value);
      });
    });

    function fetchPublicScripts() {
      const jwt = localStorage.getItem("jwt");
      fetch('./backend/user-api/get-public-scripts-api.php', {
        headers: { 'Authorization': 'Bearer ' + jwt }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.scripts) {
          allScripts = data.scripts;
          populateMarketplaceTable(allScripts);
        } else {
          console.error("Error fetching public scripts:", data.message);
        }
      })
      .catch(error => console.error("Error fetching public scripts:", error));
    }

    function populateMarketplaceTable(scripts) {
      const tbody = document.querySelector("#marketplaceTable tbody");
      tbody.innerHTML = "";
      scripts.forEach(script => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${script.script_name}</td>
          <td>${script.username}</td>
          <td>
            <button class="btn btn-sm btn-info view-btn" data-script-id="${script.id}">View Script</button>
            <button class="btn btn-sm btn-success save-btn" data-script-id="${script.id}">Save Robot</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", function() {
          const scriptId = this.getAttribute("data-script-id");
          viewScript(scriptId);
        });
      });
      document.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", function() {
          const scriptId = this.getAttribute("data-script-id");
          saveRobot(scriptId);
        });
      });
    }

    function filterScripts(searchTerm) {
      const filtered = allScripts.filter(script => {
        const lowerTerm = searchTerm.toLowerCase();
        return script.script_name.toLowerCase().includes(lowerTerm) ||
               script.username.toLowerCase().includes(lowerTerm);
      });
      populateMarketplaceTable(filtered);
    }

    function viewScript(scriptId) {
      const script = allScripts.find(s => s.id == scriptId);
      if (script) {
        document.getElementById("viewScriptModalLabel").innerText = script.script_name;
        document.getElementById("scriptContent").innerText = script.code;
        const modal = new bootstrap.Modal(document.getElementById("viewScriptModal"));
        modal.show();
      }
    }

    function saveRobot(scriptId) {
      const jwt = localStorage.getItem("jwt");
      fetch('./backend/user-api/save-robot-from-marketplace-api.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwt
        },
        body: JSON.stringify({ script_id: scriptId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Script saved successfully.");
        } else {
          alert("Error saving script: " + data.message);
        }
      })
      .catch(error => console.error("Error saving script:", error));
    }
  </script>
</body>
</html>
